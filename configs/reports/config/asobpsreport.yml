ReportDefinitions:
  - reportName: obpsApplicationReport
    decryptionPathId: StateTradeLicenseCancelledRegistryReport
    summary: Building Plan Approval Application Report
    version: 1.0.0
    moduleName: rainmaker-obps
    sourceColumns:
      - name: application_no
        label: reports.obps.applicationno
        type: string
        source: obps
        showColumn: true
        total: false

      - name: normalappdate
        label: reports.obps.normalappdate
        type: epoch
        source: obps
        showColumn: false

      - name: applicationdate
        label: reports.obps.applicationdate
        type: string
        source: obps
        showColumn: true

      - name: edcr_number
        label: reports.obps.edcrnumber
        type: string
        source: obps
        showColumn: true

      - name: applicationchannel
        label: reports.obps.applicationchannel
        type: string
        source: obps
        showColumn: true
        isLocalisationRequired: true

      - name: name
        label: rainmaker.obps.name
        type: string
        source: obps
        showColumn: true

      - name: applicationtype
        label: reports.obps.applicationtype
        type: string
        source: obps
        showColumn: true
        isLocalisationRequired: true

      - name: occupancy_type
        label: reports.obps.occupancytype
        type: string
        source: obps
        showColumn: false
        isLocalisationRequired: true

      - name: status
        label: reports.obps.status
        type: string
        source: obps
        showColumn: true
        isLocalisationRequired: true

      - name: currentowner
        label: reports.obps.currentowner
        type: string
        source: obps
        showColumn: false

      - name: planning_permit_no
        label: reports.obps.planningpermitno
        type: string
        source: obps
        showColumn: true

    searchParams:
      - name: fromdate
        label: reports.obps.fromdate
        type: epoch
        source: obps
        isMandatory: false
        searchClause: AND ($fromdate IS NULL OR bp.created_time >= ($fromdate)::bigint)

      - name: todate
        label: reports.obps.todate
        type: epoch
        source: obps
        isMandatory: false
        searchClause: AND ($todate IS NULL OR bp.created_time <= ($todate)::bigint)

      - name: applicationno
        label: reports.obps.applicationno
        type: string
        source: obps
        isMandatory: false
        searchClause: AND bp.application_no = $applicationno

    query: |
      SELECT 
       bp.application_no,
      bp.created_time as createdtime,
      bp.application_date as normalappdate, 
      to_char(To_timestamp(bp.application_date / 1000), 'DD/MM/YYYY') as applicationdate,
      bp.edcr_number, 
      landinfo.channel as applicationchannel, 
      usr.name as name,
      bp.application_type as applicationtype, 
      land.occupancy_type,
      bp.status, 
      case when st.isterminatestate=true then null else userassignee.name end as currentowner, 
      bp.planning_permit_no 
      FROM ug_bpa_buildingplans bp 
      INNER JOIN (
      SELECT DISTINCT ON (businessid) *
      FROM eg_wf_processinstance_v2
      ORDER BY businessid, createdtime DESC
      ) pi ON pi.businessid = bp.application_no
      INNER JOIN eg_wf_state_v2 st ON pi.status = st.uuid 
      INNER JOIN eg_user usr ON bp.created_by = usr.uuid  
      INNER JOIN (
      SELECT DISTINCT ON (land_info_id) *
      FROM ug_land_unit
      ORDER BY land_info_id
      ) land ON land.land_info_id = bp.land_id 
      INNER JOIN ug_land_info landinfo 
        ON land.land_info_id = landinfo.id 
      INNER JOIN (
      SELECT DISTINCT ON (land_info_id) *
      FROM ug_land_address
      ORDER BY land_info_id
      ) adr ON adr.land_info_id = landinfo.id 
      LEFT JOIN eg_user userassignee 
        ON pi.assigner = userassignee.uuid
        WHERE 1=1
        
    orderby: ORDER BY bp.application_date DESC


  - reportName: obpsRegistryReport
    decryptionPathId: StateTradeLicenseCancelledRegistryReport
    summary: OBPS Registry Report - Status Count
    version: 1.0.0
    moduleName: rainmaker-obps
    sourceColumns:
      - name: status_name
        label: reports.obps.status
        type: string
        source: obps
        showColumn: true
        isLocalisationRequired: true

      - name: count
        label: reports.obps.count
        type: number
        source: obps
        showColumn: true
        total: false

    searchParams:
      - name: status_name
        label: reports.obps.status
        type: singlevaluelist
        pattern: "list://FORWARDED_TO_TECHNICAL_ENGINEER_GP:Forwarded to Technical Engineer (GP),CITIZEN_APPROVAL:Citizen Approval Pending/Completed,PENDING_RTP_APPROVAL:RTP Approval Pending,PENDING_CHAIRMAN_DA:Pending at Chairman (DA),PENDING_DA_ENGINEER:Pending at DA Engineer,PENDING_CHAIRMAN_PRESIDENT_MB:Pending at Chairman/President (MB),PENDING_FOR_SCRUTINY:Pending for Scrutiny,PAYMENT_PENDING:Payment Pending,PENDING_DD_AD_DEVELOPMENT_AUTHORITY:Pending at DD/AD Development Authority,GIS_VALIDATION:GIS Validation in Progress,CITIZEN_FINAL_PAYMENT:Citizen Final Payment Pending,APPLICATION_COMPLETED:Application Completed,FORWARDED_TO_TECHNICAL_ENGINEER_MB:Forwarded to Technical Engineer (MB),FORWARDED_TO_DD_AD_TCP:Forwarded to DD/AD (TCP)"
        source: obps
        isMandatory: false
        wrapper: false
        isLocalisationRequired: false
        searchClause: AND status_name = replace($status_name, ',', '_')

    query: |
      SELECT
        status_name,
        count
      FROM (
        SELECT
          status AS status_name,
          COUNT(*) AS count
        FROM ug_bpa_buildingplans
        WHERE status IN (
          'FORWARDED_TO_TECHNICAL_ENGINEER_GP',
          'CITIZEN_APPROVAL',
          'PENDING_RTP_APPROVAL',
          'PENDING_CHAIRMAN_DA',
          'PENDING_DA_ENGINEER',
          'PENDING_CHAIRMAN_PRESIDENT_MB',
          'PENDING_FOR_SCRUTINY',
          'PAYMENT_PENDING',
          'PENDING_DD_AD_DEVELOPMENT_AUTHORITY',
          'GIS_VALIDATION',
          'CITIZEN_FINAL_PAYMENT',
          'APPLICATION_COMPLETED',
          'FORWARDED_TO_TECHNICAL_ENGINEER_MB',
          'FORWARDED_TO_DD_AD_TCP'
        )
        GROUP BY status
      ) status_counts
      WHERE 1=1


  - reportName: totalapplicationssummary
    summary: Total number of Applications summary
    version: 1.0.0
    moduleName: rainmaker-obps
    sourceColumns:
      - name: "Total Applications"
        label: "Total Applications"
        type: number

      - name: "Pending with the Applicant"
        label: "Pending with the Applicant"
        type: number

      - name: "Pending With the Official"
        label: "Pending With the Official"
        type: number

      - name: "Delivered"
        label: "Delivered"
        type: number

      - name: "Rejected"
        label: "Rejected"
        type: number

    searchParams: []

    query: |
      SELECT
        COUNT(*) AS "Total Applications",
        COUNT(*) FILTER (
          WHERE status IN (
            'PAYMENT_PENDING',
            'EDIT_APPLICATION',
            'CITIZEN_FINAL_PAYMENT',
            'CITIZEN_APPROVAL',
            'PENDING_FOR_SCRUTINY',
            'PENDING_RTP_APPROVAL'
          )
        ) AS "Pending with the Applicant",
        COUNT(*) FILTER (
          WHERE status IN (
            'PENDING_CEO',
            'PENDING_GMDA_ENGINEER',
            'PENDING_TOWNPLANNER',
            'PENDING_CHAIRMAN_PRESIDENT_MB',
            'PENDING_CHAIRMAN_DA',
            'PENDING_DA_ENGINEER',
            'PENDING_DD_AD_DEVELOPMENT_AUTHORITY',
            'GIS_VALIDATION',
            'FORWARDED_TO_TECHNICAL_ENGINEER_MB',
            'FORWARDED_TO_TECHNICAL_ENGINEER_GP',
            'FORWARDED_TO_DD_AD_TCP',
            'FORWARDED_TO_ZONAL_OFFICER'
          )
        ) AS "Pending With the Official",
        COUNT(*) FILTER (WHERE status = 'APPLICATION_COMPLETED') AS "Delivered",
        COUNT(*) FILTER (WHERE status = 'REJECTED') AS "Rejected"
      FROM ug_bpa_buildingplans


  - reportName: newapplicationsdatewise
    summary: New application data date-wise
    version: 1.0.0
    moduleName: rainmaker-obps
    sourceColumns:
      - name: application_no
        label: Application No
        type: string

      - name: application_date
        label: Application Date Epoch
        type: number

      - name: applicationdate
        label: Application Date
        type: string

      - name: edcr_number
        label: EDCR Number
        type: string

      - name: name
        label: Applicant Name
        type: string

      - name: applicationtype
        label: Application Type
        type: string

      - name: occupancy_type
        label: Occupancy Type
        type: string

      - name: status
        label: Status
        type: string

      - name: planning_permit_no
        label: Planning Permit No
        type: string

    searchParams: []

    query: |
      SELECT *
      FROM (
        SELECT DISTINCT ON (bp.application_no)
          bp.application_no,
          bp.application_date,
          to_char(to_timestamp(bp.application_date / 1000), 'DD/MM/YYYY') AS applicationdate,
          bp.edcr_number,
          usr.name AS name,
          bp.application_type AS applicationtype,
          land.occupancy_type,
          bp.status,
          bp.planning_permit_no
        FROM ug_bpa_buildingplans bp
        INNER JOIN eg_wf_processinstance_v2 pi ON pi.businessid = bp.application_no
        INNER JOIN eg_user usr ON bp.created_by = usr.uuid
        INNER JOIN ug_land_unit land ON land.land_info_id = bp.land_id
        INNER JOIN ug_land_info landinfo ON land.land_info_id = landinfo.id
        INNER JOIN ug_land_address adr ON adr.land_info_id = landinfo.id
        ORDER BY bp.application_no, pi.createdtime DESC
      ) x

    orderby: ORDER BY x.application_date DESC


  - reportName: dailybackendupdatesreport
    summary: Daywise list of application reference numbers where backend process is updated
    version: 1.0.0
    moduleName: rainmaker-obps
    sourceColumns:
      - name: application_no
        label: Application No
        type: string

      - name: latest_action_time
        label: Latest Action Time
        type: string

    searchParams: []

    query: |
      SELECT DISTINCT ON (bp.application_no)
        bp.application_no,
        to_char(to_timestamp(pi.createdtime / 1000), 'DD/MM/YYYY HH24:MI:SS') AS latest_action_time
      FROM eg_wf_processinstance_v2 pi
      INNER JOIN ug_bpa_buildingplans bp
        ON bp.application_no = pi.businessid
      WHERE to_timestamp(pi.createdtime / 1000)::date = CURRENT_DATE
      ORDER BY bp.application_no, pi.createdtime DESC


  - reportName: applicationworkflowtrace
    summary: Application history and timeline
    version: 1.0.0
    moduleName: rainmaker-obps
    sourceColumns:
      - name: application_no
        label: Application No
        type: string
      - name: action_time
        label: Action Time
        type: string
      - name: action
        label: Action
        type: string
      - name: wf_state
        label: Workflow State
        type: string
    searchParams:
      - name: application_no
        label: Application No
        type: string
        source: application_no
        isMandatory: true
        searchClause: AND bp.application_no = $application_no

    query: |
      SELECT
        bp.application_no,
        to_char(to_timestamp(pi.createdtime / 1000), 'DD/MM/YYYY HH24:MI:SS') AS action_time,
        pi.action,
        st.state AS wf_state
      FROM ug_bpa_buildingplans bp
      INNER JOIN eg_wf_processinstance_v2 pi
        ON pi.businessid = bp.application_no
      LEFT JOIN eg_wf_state_v2 st
        ON pi.status = st.uuid
      LEFT JOIN eg_user usr
        ON pi.createdby = usr.uuid
      WHERE 1=1

    orderby: ORDER BY pi.createdtime DESC
